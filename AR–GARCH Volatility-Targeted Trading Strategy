import numpy as np
import pandas as pd
import yfinance as yf
from statsmodels.tsa.arima.model import ARIMA
from arch import arch_model

ticker = "SPY"
start = "2010-01-01"
end = "2025-01-01"

prices = yf.download(ticker, start=start, end=end, auto_adjust=True)["Close"]
returns = np.log(prices).diff().dropna()

train_window = 756
rebalance_freq = 21
target_vol = 0.10

signals = []
realized_returns = []

dates = returns.index

for t in range(train_window, len(returns), rebalance_freq):
    train_returns = returns.iloc[t-train_window:t]

    ar_model = ARIMA(train_returns, order=(1,0,0)).fit()
    ar_forecast = ar_model.forecast(steps=rebalance_freq)

    garch = arch_model(train_returns * 100, vol="Garch", p=1, q=1)
    garch_fit = garch.fit(disp="off")
    vol_forecast = np.sqrt(garch_fit.forecast(horizon=rebalance_freq).variance.values[-1]) / 100

    position = np.sign(ar_forecast)
    scaled_position = position * (target_vol / vol_forecast)

    future_returns = returns.iloc[t:t+rebalance_freq]

    strat_returns = scaled_position[:len(future_returns)] * future_returns.values

    signals.extend(scaled_position[:len(future_returns)])
    realized_returns.extend(strat_returns)

strategy_returns = pd.Series(realized_returns, index=returns.index[train_window:train_window+len(realized_returns)])

cum_returns = (1 + strategy_returns).cumprod()

cagr = cum_returns.iloc[-1] ** (252 / len(strategy_returns)) - 1
vol = strategy_returns.std() * np.sqrt(252)
sharpe = cagr / vol

drawdown = cum_returns / cum_returns.cummax() - 1
max_dd = drawdown.min()

summary = pd.DataFrame({
    "Metric": ["CAGR", "Volatility", "Sharpe Ratio", "Max Drawdown"],
    "Value": [cagr, vol, sharpe, max_dd]
})

print(summary)
